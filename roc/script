### è¿½åŠ è¦ä»¶ã®æ•´ç†

* **å¯¾è±¡ã‚¤ãƒ™ãƒ³ãƒˆ**

  * `workitem.created` (ä½œæ¥­é …ç›®ãŒæ–°è¦ã«ä½œæˆã•ã‚ŒãŸ)
  * `workitem.updated` (æ—¢å­˜ã®ä½œæ¥­é …ç›®ãŒæ›´æ–°ã•ã‚ŒãŸ)
    Azure DevOps Service Hooks ã§ã¯ã„ãšã‚Œã‚‚æ­£å¼ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ãŠã‚Šã€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã«ã¯ `resource.fields` ã‚„ `resource.revision` ãŒå«ã¾ã‚Œã¾ã™ ([Microsoft Learn][1])
* **ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰å·®åˆ†**

  * **created** â€¦ `resource.fields["System.Title"]` ãªã©ç¾åœ¨å€¤ã®ã¿ã€‚
  * **updated** â€¦ `resource.fields.<FieldName>.oldValue / newValue` ã¨ã„ã†è¾æ›¸ã§å·®åˆ†ãŒå±Šã ([GitHub][2])
* **Rocket.Chat å´ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ API** ã¯ä»¥å‰ã¨åŒã˜ã `process_incoming_request()` ã§ JSON ã‚’æ•´å½¢ã—ã¦ `text` ã¸è¿”ã›ã°ã‚ˆã„ ([Rocket.Chat][3])

---

## å®Œå…¨ç‰ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆæ—¢å­˜ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«è¿½è¨˜æ¸ˆã¿ï¼‰

```javascript
/* exported Script */
/* globals console */

/**
 * Azure DevOps âœ Rocket.Chat Webhook Bridge
 * å¯¾å¿œã‚¤ãƒ™ãƒ³ãƒˆ:
 *   build.complete, git.pullrequest.created, git.push,
 *   workitem.created, workitem.updated
 * Rocket.Chat 6.x / Azure DevOps Server 2022 ã§ç¢ºèª
 */
class Script {
  process_incoming_request({ request }) {
    const hdr = k => (request.headers[k] || request.headers[k.toLowerCase()]);
    const event =
      hdr('X-AzureDevOps-Event') ||
      hdr('X-VSS-Event') ||
      hdr('X-MS-VSS-NotificationEvent') ||
      'unknown';

    const body = request.content || {};
    const r    = body.resource || {};

    const text = this.#format(event.toLowerCase(), body, r);

    return {
      content: {
        text,
        alias: 'Azure DevOps',
        emoji: ':rocket:'
      }
    };
  }

  #format(event, body, r) {
    switch (event) {
      /* ---------- Build å®Œäº† ---------- */
      case 'build.complete': /* çœç•¥ (å‰å›å›ç­”å‚ç…§) */ break;

      /* ---------- Pull Request ---------- */
      case 'git.pullrequest.created': /* çœç•¥ */ break;

      /* ---------- Push ---------- */
      case 'git.push': /* çœç•¥ */ break;

      /* ---------- Work Item ä½œæˆ ---------- */
      case 'workitem.created': {
        const f = r.fields || {};
        return [
          'ğŸ“ **ä½œæ¥­é …ç›® ä½œæˆ**',
          `â€¢ #${r.id}  ${f['System.Title'] ?? 'â€”'}`,
          `â€¢ ç¨®é¡: ${f['System.WorkItemType'] ?? 'â€”'}`,
          `â€¢ çŠ¶æ…‹: ${f['System.State'] ?? 'â€”'}`,
          `â€¢ æ‹…å½“: ${this.#name(f['System.AssignedTo'])}`,
          r.url ? `â€¢ [Webãƒªãƒ³ã‚¯](${r.url})` : ''
        ].filter(Boolean).join('\n');
      }

      /* ---------- Work Item æ›´æ–° ---------- */
      case 'workitem.updated': {
        const fNow   = (r.revision && r.revision.fields) || {};
        const diffs  = r.fields || {};
        const lines  = Object.entries(diffs).map(([k, v]) => {
          const key = k.split('.').pop();               // System.State â†’ State
          const old = this.#val(v.oldValue);
          const neu = this.#val(v.newValue);
          return `   â€¢ ${key}: ${old} â†’ ${neu}`;
        });
        return [
          'ğŸ”„ **ä½œæ¥­é …ç›® æ›´æ–°**',
          `â€¢ #${r.id}  ${fNow['System.Title'] ?? 'â€”'}`,
          `â€¢ ç¨®é¡: ${fNow['System.WorkItemType'] ?? 'â€”'}`,
          lines.length ? 'â€¢ å¤‰æ›´:\n' + lines.join('\n') : '',
          r.url ? `â€¢ [Webãƒªãƒ³ã‚¯](${r.url})` : ''
        ].filter(Boolean).join('\n');
      }

      /* ---------- ãã®ä»– ---------- */
      default:
        return `ğŸ“£ å—ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ **${event}**\n\`\`\`${JSON.stringify(r, null, 2).slice(0, 1500)}\`\`\``;
    }
  }

  /** displayName æŠ½å‡ºãƒ˜ãƒ«ãƒ‘ */
  #name(val) {
    if (!val) return 'â€”';
    if (typeof val === 'string') return val.split('<')[0].trim();
    return val.displayName || val.name || JSON.stringify(val);
  }

  /** undefined/null â†’ 'â€”' */
  #val(v) { return v === undefined || v === null ? 'â€”' : v; }
}
```

**ãƒã‚¤ãƒ³ãƒˆ**

| ç®‡æ‰€                 | èª¬æ˜                                                                             |
| ------------------ | ------------------------------------------------------------------------------ |
| `workitem.created` | `resource.fields` ã‹ã‚‰å¿…è¦æœ€ä½é™ã‚’æŠœãå‡ºã—ã¦ä¸€è¦§åŒ–ã€‚                                            |
| `workitem.updated` | `resource.fields` ã§å±Šãå·®åˆ†ã‚’ **ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å: æ—§ â†’ æ–°** ã®ç®‡æ¡æ›¸ãã¸æ•´å½¢ã€‚`revision.fields` ã§ç¾åœ¨å€¤ã‚‚å–å¾—ã€‚ |
| `#name()`          | `System.AssignedTo` ãŒ `"displayName <mail>"` ã‚„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã§ã‚‚å´©ã‚Œãªã„ã‚ˆã†æŠ½å‡ºã€‚              |
| é•·ã„ JSON            | æœªå¯¾å¿œã‚¤ãƒ™ãƒ³ãƒˆã¯ 1 500 æ–‡å­—ã§ä¸¸ã‚ã¦å¼•ç”¨ãƒ–ãƒ­ãƒƒã‚¯è¡¨ç¤ºã€‚                                                 |

---

## ä½¿ã„æ–¹ï¼ˆå†æ²ï¼‰

1. **Rocket.Chat**

   * *Administration â†’ Workspace â†’ Integrations â†’ Incoming â†’ New*
   * Post to: æŠ•ç¨¿å…ˆãƒãƒ£ãƒ³ãƒãƒ«
   * **Scripts Enabled** ã‚’ ON â†’ ä¸Šè¨˜ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è²¼ã‚Šä»˜ã‘ â†’ ä¿å­˜
2. **Azure DevOps Server**

   * *Project Settings â†’ Service Hooks â†’ +*
   * Service: **Web Hooks**
   * Trigger: *Work item created* / *Work item updated* ãªã©
   * Action URL: Rocket.Chat ãŒç™ºè¡Œã—ãŸ Webhook URL ã‚’è¨­å®š
3. **ãƒ†ã‚¹ãƒˆ**

   * DevOps ã§ *Test* ã‚’æŠ¼ã™ã‹å®Ÿéš›ã«ä½œæ¥­é …ç›®ã‚’ä½œæˆãƒ»æ›´æ–°ã—ã€Rocket.Chat ã«é€šçŸ¥ãŒæ¥ã‚‹ã“ã¨ã‚’ç¢ºèªã€‚

---

### è£œè¶³

* ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ã—ãŸã‘ã‚Œã° `lines` ç”Ÿæˆéƒ¨ã‚„ `#format()` ã®è¡¨ç¤ºè¡Œã‚’å¢—ã‚„ã—ã¦ãã ã•ã„ã€‚
* æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆã¯ **å·®åˆ†ãŒç„¡ã„å ´åˆ** ã‚‚ã‚ã‚‹ã®ã§ç©ºãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ã‚ã‚Šã¾ã™ã€‚
* ãƒ«ãƒ¼ãƒ ã®å‹•çš„åˆ‡ã‚Šæ›¿ãˆã‚„ã‚«ãƒ¼ãƒ‰å½¢å¼ï¼ˆattachmentsï¼‰ã«ã—ãŸã„å ´åˆã¯ `return` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã« `roomId` ã‚„ `attachments` ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

ã“ã‚Œã§ **ä½œæ¥­é …ç›®ã®è¿½åŠ ãƒ»å¤‰æ›´** ã‚‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã« Rocket.Chat ã¸ç¶ºéº—ã«æµã›ã¾ã™ã€‚ ğŸ‰

[1]: https://learn.microsoft.com/en-us/azure/devops/service-hooks/events?view=azure-devops&utm_source=chatgpt.com "Service hooks events - Azure DevOps | Microsoft Learn"
[2]: https://github.com/aspnet/AspNetWebHooks/blob/master/test/Microsoft.AspNet.WebHooks.Receivers.VSTS.Test/Payloads/WorkItemUpdatedPayloadTests.cs?utm_source=chatgpt.com "AspNetWebHooks/test/Microsoft.AspNet.WebHooks.Receivers ..."
[3]: https://docs.rocket.chat/docs/integrations?utm_source=chatgpt.com "Integrations - Rocket-Chat Documentation"
