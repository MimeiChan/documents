# 企業別ルール管理による100%ダウンロード達成アプローチ

## 企業別ルール管理の有効性

企業別ルール管理は確かに100%ダウンロードを目指す上で**最も確実なアプローチ**です。各企業のWebサイト構造が独自である以上、カスタマイズされたルールで対応するのが最も成功率が高くなります。

## URL+XPathの十分性について

基本的なケースでは以下の定義で機能しますが、すべてのケースをカバーするには不十分です：

1. **基本定義項目**：
   - レポートページのURL（IR情報ページなど）
   - ダウンロードリンクへのXPath
   - レポート識別用のキーワードフィルター

2. **追加で必要な定義**：
   - **複数階層のナビゲーション**：IR情報→レポート一覧→個別レポートという複数クリックが必要なケース
   - **フレーム/iframeの扱い**：コンテンツが別フレームに存在する場合の対応
   - **テーブル/リスト構造の解析**：年度別にリスト化されたレポートの識別方法
   - **ファイル命名規則の違い**：ダウンロードされるファイル名のパターン

## JavaScriptへの対応について

URL+XPathだけでは**JavaScriptを多用する現代的サイトには対応困難**です：

1. **対応が必要なJavaScriptケース**：
   - ボタンクリックで表示されるモーダルウィンドウ内のリンク
   - タブ切り替えで表示されるコンテンツ
   - "もっと見る"ボタンでの追加コンテンツ読み込み
   - スクロールによる遅延ロード
   - SPAフレームワーク（React/Vue/Angular）で構築されたサイト

2. **現実的な解決策**：
   - **ヘッドレスブラウザの併用**：Selenium/Playwrightなどを使用
   - **アクション定義の拡張**：
     ```
     {
       "url": "https://example.co.jp/ir/",
       "actions": [
         {"type": "click", "selector": "#tabReport"},
         {"type": "wait", "time": 1000},
         {"type": "click", "selector": ".year-selector[data-year='2024']"},
         {"type": "wait", "time": 1000},
         {"download_selector": ".pdf-link:contains('統合報告書')"}
       ],
       "fallback_xpath": "//a[contains(text(),'統合報告書') and contains(@href,'.pdf')]"
     }
     ```

## 100%達成のための統合アプローチ

企業別ルール管理を基本としつつ、以下の要素を組み合わせることで100%達成が現実的になります：

1. **階層型ルール定義**：
   - **基本パターン**：シンプルなURL+XPath（静的サイト用）
   - **中間パターン**：複数ステップナビゲーション（半動的サイト用）
   - **高度パターン**：JavaScript操作シーケンス（完全動的サイト用）

2. **企業別の処理フロー**：
   ```
   企業ID: 1234
   処理タイプ: JavaScript必須
   基本URL: https://example.co.jp/ja/ir/
   ステップ:
     1. セレクタ'.tab-menu li:nth-child(3)'をクリック
     2. 1秒待機
     3. セレクタ'.year-selector option[value="2024"]'を選択
     4. 0.5秒待機
     5. セレクタ'.document-list a:contains("統合報告書")'をクリック
   代替パス:
     1. URL: https://example.co.jp/ja/ir/library/
     2. XPath: '//table[@class="report-list"]//a[contains(text(), "統合報告書")]'
   ファイル名パターン: [会社コード]_INTEGRATED_[年度].pdf
   ```

3. **障害対策**：
   - サイト構造変更検知機能（レポート日付と実行日の差分が一定以上で警告）
   - 代替ルート定義（複数の取得パスを定義）
   - 履歴ベースのフォールバック（過去の成功URLパターンの試行）

4. **管理システム**：
   - 企業別ルール管理データベース
   - ルールエディタUI（技術者でなくても更新可能）
   - 成功率モニタリングダッシュボード

このアプローチでは初期設定とメンテナンスの工数は増えますが、100%に近い成功率を実現可能です。特に重要な企業については手厚いルール定義を行い、マイナーな変更にも対応できる柔軟性を確保することが重要です。
